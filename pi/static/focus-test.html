<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Test - Skylapse</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #f0f0f0;
        }
        h1 {
            color: #4a9eff;
            margin-bottom: 10px;
        }
        .workflow-step {
            color: #888;
            font-size: 14px;
            margin-bottom: 20px;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover {
            background: #3a8eef;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        button.primary {
            background: #ff8c42;
            font-size: 16px;
            padding: 15px 30px;
        }
        button.primary:hover {
            background: #ef7c32;
        }
        .status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            background: #333;
        }
        .status.success {
            background: #2d5a2d;
            color: #7fff7f;
        }
        .status.error {
            background: #5a2d2d;
            color: #ff7f7f;
        }
        .status.info {
            background: #2d3a5a;
            color: #7f9fff;
        }

        /* Step 1: Initialize */
        #step1 {
            text-align: center;
            padding: 40px 20px;
        }

        /* Step 2: ROI Selection */
        #step2 {
            display: none;
        }
        .roi-selection-area {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .reference-panel {
            flex: 0 0 400px;
        }
        .roi-container {
            position: relative;
            display: inline-block;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: hidden;
        }
        .roi-container img {
            display: block;
            max-width: 100%;
            height: auto;
        }
        .roi-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            pointer-events: auto;
        }
        .roi-controls {
            margin-top: 15px;
            text-align: center;
        }
        .roi-status {
            margin-top: 10px;
            color: #4a9eff;
            font-weight: 500;
        }

        /* Step 3: Focus Testing */
        #step3 {
            display: none;
        }
        .focus-test-area {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        .roi-display {
            flex: 1;
            text-align: center;
        }
        .roi-zoom-canvas {
            border: 3px solid #4a9eff;
            border-radius: 8px;
            background: #000;
            width: 100%;
            height: auto;
            box-shadow: 0 4px 20px rgba(74, 158, 255, 0.3);
        }
        .lens-position-display {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
        }
        .sharpness-display {
            margin-top: 10px;
            font-size: 18px;
            color: #7fff7f;
        }
        .sharpness-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .sharpness-fill {
            height: 100%;
            background: linear-gradient(to right, #ff4444, #ffaa44, #7fff7f);
            transition: width 0.3s ease;
        }
        .view-toggle {
            margin-top: 15px;
            padding: 10px 20px;
            background: #555;
            border: 2px solid #777;
            border-radius: 6px;
            cursor: pointer;
        }
        .view-toggle:hover {
            background: #666;
        }
        .fullscreen-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .fullscreen-view.active {
            display: flex;
        }
        .fullscreen-image {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }

        .focus-controls {
            flex: 0 0 350px;
            background: #2a2a2a;
            padding: 25px;
            border-radius: 8px;
        }
        .focus-controls h3 {
            margin-top: 0;
            color: #4a9eff;
        }
        .coarse-controls {
            margin-bottom: 25px;
        }
        .coarse-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .coarse-buttons button {
            padding: 10px 5px;
            font-size: 13px;
        }
        .fine-controls {
            margin-bottom: 25px;
        }
        .fine-adjust {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }
        .arrow-btn {
            font-size: 20px;
            padding: 10px 20px;
            background: #555;
        }
        .arrow-btn:hover {
            background: #666;
        }
        .current-position {
            font-size: 18px;
            font-weight: bold;
            color: #4a9eff;
            min-width: 60px;
            text-align: center;
        }
        .step-size {
            text-align: center;
            margin-top: 10px;
            color: #888;
            font-size: 13px;
        }
        .reset-controls {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #444;
        }
        .reset-controls button {
            width: 100%;
            background: #666;
        }
        .reset-controls button:hover {
            background: #777;
        }

        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üîç Focus Test - Persistent ROI</h1>

    <!-- Step 1: Initialize -->
    <div id="step1">
        <div class="workflow-step">
            <strong>Workflow:</strong> Initialize ‚Üí Select ROI on mountain peaks ‚Üí Adjust focus until sharp
        </div>
        <button class="primary" onclick="initialize()">üéØ Initialize (Capture with Auto Settings)</button>
        <div id="status1" class="status" style="display: none;"></div>
    </div>

    <!-- Step 2: Select ROI -->
    <div id="step2">
        <h2>Step 2: Select Region of Interest</h2>
        <p>Click and drag on the mountain peaks to define your ROI, then lock it.</p>

        <div class="roi-selection-area">
            <div class="reference-panel">
                <h3>Reference Image</h3>
                <div class="roi-container" id="roiContainer">
                    <img id="roiImage" src="">
                    <canvas id="roiCanvas" class="roi-canvas"></canvas>
                </div>
                <div class="roi-controls">
                    <button onclick="lockROI()" id="lockButton" disabled>üîí Lock ROI</button>
                    <div class="roi-status" id="roiStatus"></div>
                </div>
            </div>

            <div style="flex: 1;">
                <h3>ROI Preview</h3>
                <canvas id="previewCanvas" style="max-width: 100%; border: 2px solid #444; border-radius: 8px; background: #000;"></canvas>
                <p style="color: #888; margin-top: 10px;">Draw a selection on the reference image to see preview</p>
            </div>
        </div>

        <div id="status2" class="status" style="display: none;"></div>
    </div>

    <!-- Step 3: Focus Testing -->
    <div id="step3">
        <h2>Step 3: Find Optimal Focus</h2>
        <p>Use coarse controls to get close, then fine-tune with arrows. Watch the ROI for maximum sharpness.</p>

        <div class="focus-test-area">
            <div class="roi-display">
                <h3>ROI Live View (Dynamic Zoom)</h3>
                <canvas id="zoomCanvas" class="roi-zoom-canvas"></canvas>
                <div class="lens-position-display" id="lensPositionDisplay">Lens Position: --</div>
                <div class="sharpness-display">
                    <div>Sharpness: <strong id="sharpnessScore">--</strong></div>
                    <div class="sharpness-bar">
                        <div class="sharpness-fill" id="sharpnessFill" style="width: 0%"></div>
                    </div>
                </div>
                <button class="view-toggle" onclick="toggleFullView()" id="viewToggleBtn">
                    üì∑ View Full Image (F)
                </button>
            </div>

            <div class="focus-controls">
                <h3>Focus Controls</h3>

                <div class="coarse-controls">
                    <h4 style="margin-bottom: 8px;">Coarse Adjust (Jump to position)</h4>
                    <div class="coarse-buttons">
                        <button onclick="jumpToPosition(0.0)">0.0</button>
                        <button onclick="jumpToPosition(1.0)">1.0</button>
                        <button onclick="jumpToPosition(2.0)">2.0</button>
                        <button onclick="jumpToPosition(3.0)">3.0</button>
                        <button onclick="jumpToPosition(4.0)">4.0</button>
                        <button onclick="jumpToPosition(5.0)">5.0</button>
                        <button onclick="jumpToPosition(6.0)">6.0</button>
                        <button onclick="jumpToPosition(6.5)">6.5</button>
                    </div>
                </div>

                <div class="fine-controls">
                    <h4 style="margin-bottom: 8px;">Fine Adjust</h4>
                    <div class="fine-adjust">
                        <button class="arrow-btn" onclick="adjustFocus(-0.5)">‚óÑ‚óÑ‚óÑ</button>
                        <button class="arrow-btn" onclick="adjustFocus(-0.1)">‚óÑ‚óÑ</button>
                        <button class="arrow-btn" onclick="adjustFocus(-0.01)">‚óÑ</button>
                        <span class="current-position" id="currentPosition">--</span>
                        <button class="arrow-btn" onclick="adjustFocus(0.01)">‚ñ∫</button>
                        <button class="arrow-btn" onclick="adjustFocus(0.1)">‚ñ∫‚ñ∫</button>
                        <button class="arrow-btn" onclick="adjustFocus(0.5)">‚ñ∫‚ñ∫‚ñ∫</button>
                    </div>
                    <div class="step-size">‚óÑ = -0.01 | ‚óÑ‚óÑ = -0.1 | ‚óÑ‚óÑ‚óÑ = -0.5</div>
                </div>

                <div class="reset-controls">
                    <button onclick="resetWorkflow()">üîÑ Start Over</button>
                </div>
            </div>
        </div>

        <div id="status3" class="status" style="display: none;"></div>
    </div>

    <!-- Fullscreen View Overlay -->
    <div id="fullscreenView" class="fullscreen-view" onclick="toggleFullView()">
        <img id="fullscreenImage" class="fullscreen-image" src="">
    </div>

    <script>
        const API_BASE = '';  // Same origin

        let state = {
            currentLensPosition: null,
            currentFullImage: null,  // Store the current full-res image for fullscreen view
            roiImage: null,
            isDrawing: false,
            startX: 0,
            startY: 0,
            endX: 0,
            endY: 0,
            locked: false,
            lockedBounds: null  // {x, y, width, height, scaleX, scaleY}
        };

        // Step 1: Initialize with auto capture
        async function initialize() {
            showStatus('status1', 'Capturing initial image with auto settings...', 'info');
            disableButton('Initialize button', true);

            try {
                const response = await fetch(`${API_BASE}/focus-test/auto`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                state.currentLensPosition = result.lens_position || 3.0;

                showStatus('status1', `‚úì Captured successfully (lens: ${state.currentLensPosition.toFixed(2)})`, 'success');

                // Load the captured image
                const imageUrl = `${API_BASE}/images/focus-test/${result.filename}`;
                loadReferenceImage(imageUrl);

                // Move to step 2
                setTimeout(() => {
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                }, 500);

            } catch (error) {
                showStatus('status1', `‚úó Capture failed: ${error.message}`, 'error');
                disableButton('Initialize button', false);
            }
        }

        function disableButton(label, disabled) {
            // Simplified button disabling
            document.querySelectorAll('button').forEach(btn => {
                if (label === 'Initialize button' && btn.textContent.includes('Initialize')) {
                    btn.disabled = disabled;
                }
            });
        }

        // Step 2: Load reference image and set up ROI selection
        function loadReferenceImage(imageUrl) {
            const roiImage = document.getElementById('roiImage');
            const roiCanvas = document.getElementById('roiCanvas');

            roiImage.onload = function() {
                // Set canvas to match image display dimensions
                roiCanvas.width = roiImage.width;
                roiCanvas.height = roiImage.height;
                roiCanvas.style.width = roiImage.width + 'px';
                roiCanvas.style.height = roiImage.height + 'px';

                state.roiImage = roiImage;

                showStatus('status2', '‚úì Image loaded - Draw a rectangle on the mountain peaks', 'success');
            };

            roiImage.src = imageUrl;
        }

        // ROI Selection - Canvas event handlers
        const roiCanvas = document.getElementById('roiCanvas');

        roiCanvas.addEventListener('mousedown', (e) => {
            if (state.locked) return;

            const rect = roiCanvas.getBoundingClientRect();
            state.isDrawing = true;
            state.startX = e.clientX - rect.left;
            state.startY = e.clientY - rect.top;
        });

        roiCanvas.addEventListener('mousemove', (e) => {
            if (!state.isDrawing || state.locked) return;

            const rect = roiCanvas.getBoundingClientRect();
            const ctx = roiCanvas.getContext('2d');

            state.endX = e.clientX - rect.left;
            state.endY = e.clientY - rect.top;

            // Clear and redraw selection rectangle
            ctx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
            ctx.strokeStyle = '#4a9eff';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                state.startX,
                state.startY,
                state.endX - state.startX,
                state.endY - state.startY
            );
        });

        roiCanvas.addEventListener('mouseup', (e) => {
            if (!state.isDrawing || state.locked) return;

            state.isDrawing = false;

            const rect = roiCanvas.getBoundingClientRect();
            state.endX = e.clientX - rect.left;
            state.endY = e.clientY - rect.top;

            // Enable lock button and show preview
            document.getElementById('lockButton').disabled = false;
            drawPreview();
        });

        function drawPreview() {
            if (!state.roiImage) return;

            const x = Math.min(state.startX, state.endX);
            const y = Math.min(state.startY, state.endY);
            const width = Math.abs(state.endX - state.startX);
            const height = Math.abs(state.endY - state.startY);

            if (width < 10 || height < 10) {
                showStatus('status2', '‚úó Selection too small - drag a larger region', 'error');
                return;
            }

            const scaleX = state.roiImage.naturalWidth / state.roiImage.width;
            const scaleY = state.roiImage.naturalHeight / state.roiImage.height;

            const srcX = x * scaleX;
            const srcY = y * scaleY;
            const srcWidth = width * scaleX;
            const srcHeight = height * scaleY;

            const previewCanvas = document.getElementById('previewCanvas');
            previewCanvas.width = width * 2;
            previewCanvas.height = height * 2;

            const ctx = previewCanvas.getContext('2d');
            ctx.drawImage(
                state.roiImage,
                srcX, srcY, srcWidth, srcHeight,
                0, 0, previewCanvas.width, previewCanvas.height
            );

            document.getElementById('roiStatus').textContent = `Selection: ${width}√ó${height}px`;
        }

        function lockROI() {
            if (!state.roiImage) return;

            const x = Math.min(state.startX, state.endX);
            const y = Math.min(state.startY, state.endY);
            const width = Math.abs(state.endX - state.startX);
            const height = Math.abs(state.endY - state.startY);

            if (width < 10 || height < 10) {
                showStatus('status2', '‚úó ROI too small to lock', 'error');
                return;
            }

            const scaleX = state.roiImage.naturalWidth / state.roiImage.width;
            const scaleY = state.roiImage.naturalHeight / state.roiImage.height;

            state.locked = true;
            state.lockedBounds = {
                x: x,
                y: y,
                width: width,
                height: height,
                scaleX: scaleX,
                scaleY: scaleY
            };

            document.getElementById('lockButton').disabled = true;
            document.getElementById('roiStatus').textContent = `üîí Locked (${width}√ó${height}px)`;

            showStatus('status2', '‚úì ROI locked! Moving to focus testing...', 'success');

            // Move to step 3
            setTimeout(() => {
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'block';

                // Display the locked ROI from the reference image
                displayROI(state.roiImage, state.currentLensPosition);
            }, 800);
        }

        // Calculate sharpness using Laplacian variance (edge detection)
        function calculateSharpness(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // Subsample for performance (every 4th pixel)
            let laplacianSum = 0;
            let count = 0;

            for (let y = 4; y < height - 4; y += 4) {
                for (let x = 4; x < width - 4; x += 4) {
                    const idx = (y * width + x) * 4;
                    const center = data[idx]; // Just use red channel

                    // Simple Laplacian: center - average of neighbors
                    const top = data[((y-4) * width + x) * 4];
                    const bottom = data[((y+4) * width + x) * 4];
                    const left = data[(y * width + (x-4)) * 4];
                    const right = data[(y * width + (x+4)) * 4];

                    const laplacian = Math.abs(4 * center - top - bottom - left - right);
                    laplacianSum += laplacian * laplacian;
                    count++;
                }
            }

            // Return variance (normalized to 0-100 range for display)
            return Math.min(100, Math.sqrt(laplacianSum / count) / 2);
        }

        // Step 3: Focus testing
        function displayROI(image, lensPosition) {
            if (!state.lockedBounds) return;

            const bounds = state.lockedBounds;
            const srcX = bounds.x * bounds.scaleX;
            const srcY = bounds.y * bounds.scaleY;
            const srcWidth = bounds.width * bounds.scaleX;
            const srcHeight = bounds.height * bounds.scaleY;

            const zoomCanvas = document.getElementById('zoomCanvas');

            // Dynamically calculate zoom to fill ~1000px width target
            const TARGET_WIDTH = 1000;
            const zoomFactor = Math.max(1, TARGET_WIDTH / srcWidth);

            zoomCanvas.width = srcWidth * zoomFactor;
            zoomCanvas.height = srcHeight * zoomFactor;

            const ctx = zoomCanvas.getContext('2d');
            ctx.drawImage(
                image,
                srcX, srcY, srcWidth, srcHeight,
                0, 0, zoomCanvas.width, zoomCanvas.height
            );

            // Calculate sharpness metric
            const sharpness = calculateSharpness(ctx, zoomCanvas.width, zoomCanvas.height);

            // Store current image for fullscreen view
            state.currentFullImage = image.src;

            // Update displays
            const actualZoom = zoomFactor.toFixed(1);
            document.getElementById('lensPositionDisplay').textContent = `Lens Position: ${lensPosition.toFixed(2)} | Zoom: ${actualZoom}x`;
            document.getElementById('currentPosition').textContent = lensPosition.toFixed(1);
            document.getElementById('sharpnessScore').textContent = sharpness.toFixed(1);
            document.getElementById('sharpnessFill').style.width = `${sharpness}%`;
        }

        async function jumpToPosition(lensPosition) {
            await captureAndDisplayROI(lensPosition);
        }

        async function adjustFocus(delta) {
            if (state.currentLensPosition === null) {
                state.currentLensPosition = 3.0;
            }

            let newPosition = state.currentLensPosition + delta;
            newPosition = Math.max(0, Math.min(6.5, newPosition));  // Clamp to valid range

            await captureAndDisplayROI(newPosition);
        }

        async function captureAndDisplayROI(lensPosition) {
            showStatus('status3', `Capturing at lens position ${lensPosition.toFixed(2)}...`, 'info');

            try {
                const response = await fetch(`${API_BASE}/focus-test?lens_position=${lensPosition}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                state.currentLensPosition = lensPosition;

                // Load the new image and display ROI
                const newImage = new Image();
                newImage.onload = function() {
                    displayROI(newImage, lensPosition);
                    showStatus('status3', `‚úì Captured at ${lensPosition.toFixed(2)}`, 'success');
                };
                newImage.src = `${API_BASE}/images/focus-test/${result.filename}`;

            } catch (error) {
                showStatus('status3', `‚úó Capture failed: ${error.message}`, 'error');
            }
        }

        function resetWorkflow() {
            // Reset state
            state = {
                currentLensPosition: null,
                roiImage: null,
                isDrawing: false,
                startX: 0,
                startY: 0,
                endX: 0,
                endY: 0,
                locked: false,
                lockedBounds: null
            };

            // Clear canvases
            const roiCanvas = document.getElementById('roiCanvas');
            const ctx = roiCanvas.getContext('2d');
            ctx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);

            // Reset UI
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';

            showStatus('status1', 'Ready to start over', 'info');
            setTimeout(() => {
                document.getElementById('status1').style.display = 'none';
            }, 2000);
        }

        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        // Toggle fullscreen view of current image
        function toggleFullView() {
            const fullscreenView = document.getElementById('fullscreenView');
            const fullscreenImage = document.getElementById('fullscreenImage');

            if (fullscreenView.classList.contains('active')) {
                fullscreenView.classList.remove('active');
            } else {
                if (state.currentFullImage) {
                    fullscreenImage.src = state.currentFullImage;
                    fullscreenView.classList.add('active');
                }
            }
        }

        // Keyboard shortcut: F to toggle fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                toggleFullView();
            }
            // ESC to close fullscreen
            if (e.key === 'Escape') {
                document.getElementById('fullscreenView').classList.remove('active');
            }
        });
    </script>
</body>
</html>
