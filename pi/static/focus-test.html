<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Test - Skylapse</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #f0f0f0;
        }
        h1 {
            color: #4a9eff;
        }
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover {
            background: #3a8eef;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        button.auto-focus {
            background: #ff8c42;
        }
        button.auto-focus:hover {
            background: #ef7c32;
        }
        .custom-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        input[type="number"] {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: #f0f0f0;
            font-size: 14px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            background: #333;
        }
        .status.success {
            background: #2d5a2d;
            color: #7fff7f;
        }
        .status.error {
            background: #5a2d2d;
            color: #ff7f7f;
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .image-card {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .image-card:hover {
            transform: scale(1.02);
        }
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }
        .roi-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        .roi-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            pointer-events: auto;
        }
        .roi-zoom {
            margin-top: 20px;
            border: 2px solid #4a9eff;
            border-radius: 8px;
            background: #1a1a1a;
            padding: 10px;
        }
        .roi-zoom canvas {
            display: block;
            margin: 10px auto;
            border: 1px solid #444;
        }
        .roi-controls {
            text-align: center;
            margin-top: 10px;
        }
        .image-info {
            padding: 15px;
        }
        .lens-position {
            font-size: 18px;
            font-weight: bold;
            color: #4a9eff;
        }
        .auto-label {
            color: #ff8c42;
        }
        .timestamp {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }
        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üîç Focus Test - ArduCam IMX519</h1>

    <div class="controls">
        <h2>Capture Test Images</h2>
        <p>Click a preset lens position to capture a test image. ArduCam IMX519 effective range: 0.0-6.5</p>

        <div class="preset-buttons">
            <button onclick="captureAtPosition(0.0)">0.0 (Close)</button>
            <button onclick="captureAtPosition(0.5)">0.5</button>
            <button onclick="captureAtPosition(1.0)">1.0</button>
            <button onclick="captureAtPosition(2.0)">2.0</button>
            <button onclick="captureAtPosition(3.0)">3.0</button>
            <button onclick="captureAtPosition(4.0)">4.0</button>
            <button onclick="captureAtPosition(5.0)">5.0</button>
            <button onclick="captureAtPosition(6.0)">6.0 (Far)</button>
        </div>

        <button class="auto-focus" onclick="captureAutofocus()">üéØ Autofocus (Detect Position)</button>

        <div class="custom-input">
            <input type="number" id="customPosition" placeholder="Custom position (0.0-6.5)" step="0.1" min="0" max="6.5">
            <button onclick="captureCustomPosition()">Capture Custom</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>
    </div>

    <h2>Captured Images</h2>
    <button onclick="loadImages()">üîÑ Refresh Images</button>
    <div id="images" class="images-grid"></div>

    <h2>Persistent ROI Focus Tester</h2>
    <p><strong>Workflow:</strong> 1) Load reference image, 2) Define ROI on mountain peaks, 3) Lock ROI, 4) Capture with different focus settings and see same region automatically.</p>

    <div id="roiInspector">
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <!-- Reference Image with ROI Selection -->
            <div style="flex: 1; min-width: 400px;">
                <h3>Reference Image & ROI Selection</h3>
                <div class="roi-container" id="roiContainer" style="display: none;">
                    <img id="roiImage" src="" style="max-width: 100%; display: block;">
                    <canvas id="roiCanvas" class="roi-canvas"></canvas>
                </div>
                <div class="roi-controls" style="margin-top: 10px;">
                    <button onclick="lockROI()" id="lockButton" disabled>üîí Lock ROI</button>
                    <button onclick="unlockROI()" id="unlockButton" disabled>üîì Unlock & Reset</button>
                    <span id="roiStatus" style="margin-left: 10px; color: #888;"></span>
                </div>
            </div>

            <!-- Live Focus Test Preview -->
            <div style="flex: 1; min-width: 400px;">
                <h3>Live Focus Preview (ROI Only)</h3>
                <div id="roiZoom" class="roi-zoom" style="display: none;">
                    <canvas id="zoomCanvas"></canvas>
                    <div style="text-align: center; margin-top: 10px;">
                        <strong id="currentLensPos">Lens Position: --</strong>
                    </div>
                </div>
                <p id="roiPlaceholder" style="color: #888; text-align: center;">Define and lock an ROI to start testing focus</p>
            </div>
        </div>

        <!-- Quick Focus Controls -->
        <div style="margin-top: 20px; background: #2a2a2a; padding: 20px; border-radius: 8px;">
            <h3>Quick Focus Test (with locked ROI)</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <button onclick="captureAtPositionAndShowROI(0.0)" id="testBtn0">Test 0.0</button>
                <button onclick="captureAtPositionAndShowROI(0.5)" id="testBtn1">Test 0.5</button>
                <button onclick="captureAtPositionAndShowROI(1.0)" id="testBtn2">Test 1.0</button>
                <button onclick="captureAtPositionAndShowROI(2.0)" id="testBtn3">Test 2.0</button>
                <button onclick="captureAtPositionAndShowROI(3.0)" id="testBtn4">Test 3.0</button>
                <button onclick="captureAtPositionAndShowROI(4.0)" id="testBtn5">Test 4.0</button>
                <button onclick="captureAtPositionAndShowROI(5.0)" id="testBtn6">Test 5.0</button>
                <button onclick="captureAtPositionAndShowROI(6.0)" id="testBtn7">Test 6.0</button>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <input type="number" id="customFocusPosition" placeholder="Custom (0.0-6.5)" step="0.1" min="0" max="6.5" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #333; color: #f0f0f0;">
                <button onclick="captureCustomFocusPosition()" style="flex: 0 0 auto;">Test Custom</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal" onclick="closeModal()">
        <img id="modalImage" src="" alt="Full size image">
    </div>

    <script>
        const API_BASE = '';  // Same origin

        async function captureAtPosition(lensPosition) {
            showStatus(`Capturing at lens position ${lensPosition}...`, 'info');
            disableButtons(true);

            try {
                const response = await fetch(`${API_BASE}/focus-test?lens_position=${lensPosition}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                showStatus(`‚úì Captured at lens position ${lensPosition}`, 'success');

                // Reload images after a brief delay
                setTimeout(loadImages, 500);
            } catch (error) {
                showStatus(`‚úó Capture failed: ${error.message}`, 'error');
            } finally {
                disableButtons(false);
            }
        }

        async function captureAutofocus() {
            showStatus('Capturing with autofocus...', 'info');
            disableButtons(true);

            try {
                const response = await fetch(`${API_BASE}/focus-test/auto`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                const detectedPos = result.lens_position ? result.lens_position.toFixed(2) : 'unknown';
                showStatus(`‚úì Autofocus captured - detected lens position: ${detectedPos}`, 'success');

                setTimeout(loadImages, 500);
            } catch (error) {
                showStatus(`‚úó Autofocus capture failed: ${error.message}`, 'error');
            } finally {
                disableButtons(false);
            }
        }

        async function captureCustomPosition() {
            const input = document.getElementById('customPosition');
            const lensPosition = parseFloat(input.value);

            if (isNaN(lensPosition) || lensPosition < 0 || lensPosition > 6.5) {
                showStatus('‚úó Please enter a valid lens position (0.0-6.5)', 'error');
                return;
            }

            await captureAtPosition(lensPosition);
        }

        async function loadImages() {
            try {
                const response = await fetch(`${API_BASE}/focus-test/images`);
                const data = await response.json();

                const imagesDiv = document.getElementById('images');

                if (data.images.length === 0) {
                    imagesDiv.innerHTML = '<p style="color: #888;">No images captured yet. Click a button above to capture test images.</p>';
                    return;
                }

                imagesDiv.innerHTML = data.images.map(img => {
                    const isAuto = img.filename.includes('_auto_');
                    const lensLabel = isAuto
                        ? `<span class="auto-label">Auto (${img.lens_position !== null ? img.lens_position.toFixed(2) : '?'})</span>`
                        : `Lens ${img.lens_position !== null ? img.lens_position.toFixed(1) : '?'}`;

                    const timestamp = new Date(img.modified).toLocaleString();

                    return `
                        <div class="image-card">
                            <img src="${API_BASE}${img.url}" alt="${img.filename}"
                                 onclick="loadImageForROI('${API_BASE}${img.url}', '${lensLabel}')"
                                 ondblclick="openModal('${API_BASE}${img.url}')">
                            <div class="image-info">
                                <div class="lens-position">${lensLabel}</div>
                                <div class="timestamp">${timestamp}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load images:', error);
                showStatus(`‚úó Failed to load images: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function disableButtons(disabled) {
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = disabled;
            });
        }

        function openModal(imageSrc) {
            const modal = document.getElementById('modal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('show');
        }

        // ROI Selection and Zoom functionality
        let roiState = {
            image: null,
            isDrawing: false,
            startX: 0,
            startY: 0,
            endX: 0,
            endY: 0,
            locked: false,
            lockedBounds: null  // {x, y, width, height, scaleX, scaleY}
        };

        function loadImageForROI(imageSrc, lensLabel) {
            const roiImage = document.getElementById('roiImage');
            const roiContainer = document.getElementById('roiContainer');
            const canvas = document.getElementById('roiCanvas');

            // Load the image
            roiImage.onload = function() {
                // Show container
                roiContainer.style.display = 'block';

                // Set canvas to match image dimensions
                canvas.width = roiImage.width;
                canvas.height = roiImage.height;

                // Position canvas over image
                canvas.style.width = roiImage.width + 'px';
                canvas.style.height = roiImage.height + 'px';

                // Store the image for cropping
                roiState.image = roiImage;

                // Clear any previous selection
                clearROI();

                showStatus(`‚úì Loaded ${lensLabel} - Click and drag to select mountain peaks for zoom`, 'success');

                // Scroll to ROI inspector
                document.getElementById('roiInspector').scrollIntoView({ behavior: 'smooth', block: 'start' });
            };

            roiImage.src = imageSrc;
        }

        function clearROI() {
            const canvas = document.getElementById('roiCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            document.getElementById('roiZoom').style.display = 'none';

            roiState.isDrawing = false;
            roiState.startX = 0;
            roiState.startY = 0;
            roiState.endX = 0;
            roiState.endY = 0;
        }

        // Set up canvas event listeners
        const roiCanvas = document.getElementById('roiCanvas');

        roiCanvas.addEventListener('mousedown', (e) => {
            const rect = roiCanvas.getBoundingClientRect();
            roiState.isDrawing = true;
            roiState.startX = e.clientX - rect.left;
            roiState.startY = e.clientY - rect.top;
        });

        roiCanvas.addEventListener('mousemove', (e) => {
            if (!roiState.isDrawing) return;

            const rect = roiCanvas.getBoundingClientRect();
            const ctx = roiCanvas.getContext('2d');

            roiState.endX = e.clientX - rect.left;
            roiState.endY = e.clientY - rect.top;

            // Clear and redraw selection rectangle
            ctx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
            ctx.strokeStyle = '#4a9eff';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                roiState.startX,
                roiState.startY,
                roiState.endX - roiState.startX,
                roiState.endY - roiState.startY
            );
        });

        roiCanvas.addEventListener('mouseup', (e) => {
            if (!roiState.isDrawing || roiState.locked) return;

            roiState.isDrawing = false;

            const rect = roiCanvas.getBoundingClientRect();
            roiState.endX = e.clientX - rect.left;
            roiState.endY = e.clientY - rect.top;

            // Enable lock button
            document.getElementById('lockButton').disabled = false;

            // Draw zoomed region
            drawZoomedRegion();
        });

        function drawZoomedRegion() {
            if (!roiState.image) return;

            // Calculate selection bounds
            const x = Math.min(roiState.startX, roiState.endX);
            const y = Math.min(roiState.startY, roiState.endY);
            const width = Math.abs(roiState.endX - roiState.startX);
            const height = Math.abs(roiState.endY - roiState.startY);

            if (width < 10 || height < 10) {
                showStatus('‚úó Selection too small - drag a larger region', 'error');
                return;
            }

            // Get the actual image dimensions vs display dimensions
            const scaleX = roiState.image.naturalWidth / roiState.image.width;
            const scaleY = roiState.image.naturalHeight / roiState.image.height;

            // Calculate source coordinates in the original image
            const srcX = x * scaleX;
            const srcY = y * scaleY;
            const srcWidth = width * scaleX;
            const srcHeight = height * scaleY;

            // Set up zoom canvas
            const zoomCanvas = document.getElementById('zoomCanvas');
            const ZOOM_FACTOR = 2; // 2x magnification
            zoomCanvas.width = width * ZOOM_FACTOR;
            zoomCanvas.height = height * ZOOM_FACTOR;

            const zoomCtx = zoomCanvas.getContext('2d');

            // Draw the cropped and zoomed region
            zoomCtx.drawImage(
                roiState.image,
                srcX, srcY, srcWidth, srcHeight,  // Source rectangle
                0, 0, zoomCanvas.width, zoomCanvas.height  // Destination rectangle
            );

            // Show zoom container
            document.getElementById('roiZoom').style.display = 'block';

            showStatus(`‚úì Zoomed ${width}x${height}px region at ${ZOOM_FACTOR}x magnification`, 'success');
        }

        // Lock/Unlock ROI functions
        function lockROI() {
            if (!roiState.image) return;

            // Calculate and save ROI bounds
            const x = Math.min(roiState.startX, roiState.endX);
            const y = Math.min(roiState.startY, roiState.endY);
            const width = Math.abs(roiState.endX - roiState.startX);
            const height = Math.abs(roiState.endY - roiState.startY);

            if (width < 10 || height < 10) {
                showStatus('‚úó ROI too small to lock', 'error');
                return;
            }

            const scaleX = roiState.image.naturalWidth / roiState.image.width;
            const scaleY = roiState.image.naturalHeight / roiState.image.height;

            roiState.locked = true;
            roiState.lockedBounds = {
                x: x,
                y: y,
                width: width,
                height: height,
                scaleX: scaleX,
                scaleY: scaleY
            };

            // Update UI
            document.getElementById('lockButton').disabled = true;
            document.getElementById('unlockButton').disabled = false;
            document.getElementById('roiStatus').textContent = `üîí Locked (${width}√ó${height}px)`;
            document.getElementById('roiPlaceholder').style.display = 'none';

            // Disable test buttons during lock
            for (let i = 0; i < 8; i++) {
                document.getElementById(`testBtn${i}`).disabled = false;
            }

            showStatus('‚úì ROI locked - Now test different focus positions', 'success');
        }

        function unlockROI() {
            roiState.locked = false;
            roiState.lockedBounds = null;

            // Clear canvas
            const canvas = document.getElementById('roiCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Update UI
            document.getElementById('lockButton').disabled = false;
            document.getElementById('unlockButton').disabled = true;
            document.getElementById('roiStatus').textContent = '';
            document.getElementById('roiZoom').style.display = 'none';
            document.getElementById('roiPlaceholder').style.display = 'block';

            // Disable test buttons
            for (let i = 0; i < 8; i++) {
                document.getElementById(`testBtn${i}`).disabled = true;
            }

            showStatus('‚úì ROI unlocked - Draw a new selection', 'success');
        }

        // Capture with locked ROI and auto-display
        async function captureAtPositionAndShowROI(lensPosition) {
            if (!roiState.locked) {
                showStatus('‚úó Please lock an ROI first', 'error');
                return;
            }

            showStatus(`Capturing at lens position ${lensPosition}...`, 'info');
            disableButtons(true);

            try {
                const response = await fetch(`${API_BASE}/focus-test?lens_position=${lensPosition}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                // Load the new image and extract the locked ROI
                const newImage = new Image();
                newImage.onload = function() {
                    displayLockedROI(newImage, lensPosition);
                    showStatus(`‚úì Captured at ${lensPosition}`, 'success');
                };
                newImage.src = `${API_BASE}/images/focus-test/${result.filename}`;

            } catch (error) {
                showStatus(`‚úó Capture failed: ${error.message}`, 'error');
            } finally {
                disableButtons(false);
            }
        }

        async function captureCustomFocusPosition() {
            const input = document.getElementById('customFocusPosition');
            const lensPosition = parseFloat(input.value);

            if (isNaN(lensPosition) || lensPosition < 0 || lensPosition > 6.5) {
                showStatus('‚úó Please enter a valid lens position (0.0-6.5)', 'error');
                return;
            }

            await captureAtPositionAndShowROI(lensPosition);
        }

        function displayLockedROI(image, lensPosition) {
            if (!roiState.lockedBounds) return;

            const bounds = roiState.lockedBounds;

            // Calculate source coordinates using locked scale factors
            const srcX = bounds.x * bounds.scaleX;
            const srcY = bounds.y * bounds.scaleY;
            const srcWidth = bounds.width * bounds.scaleX;
            const srcHeight = bounds.height * bounds.scaleY;

            // Set up zoom canvas
            const zoomCanvas = document.getElementById('zoomCanvas');
            const ZOOM_FACTOR = 2;
            zoomCanvas.width = bounds.width * ZOOM_FACTOR;
            zoomCanvas.height = bounds.height * ZOOM_FACTOR;

            const zoomCtx = zoomCanvas.getContext('2d');

            // Draw the cropped and zoomed region
            zoomCtx.drawImage(
                image,
                srcX, srcY, srcWidth, srcHeight,  // Source rectangle
                0, 0, zoomCanvas.width, zoomCanvas.height  // Destination rectangle
            );

            // Show zoom container
            document.getElementById('roiZoom').style.display = 'block';
            document.getElementById('currentLensPos').textContent = `Lens Position: ${lensPosition.toFixed(1)}`;
        }

        // Initialize buttons as disabled
        for (let i = 0; i < 8; i++) {
            document.getElementById(`testBtn${i}`).disabled = true;
        }

        // Load images on page load
        loadImages();
    </script>
</body>
</html>
